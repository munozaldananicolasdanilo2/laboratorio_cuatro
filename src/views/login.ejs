<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar sesión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .card-custom { border: none; border-radius: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
    .icon-bg { width: 80px; height: 80px; border-radius: 20px; display:flex; align-items:center; justify-content:center; margin:-50px auto 10px; font-size:2rem; background:#2664eb; color:#fff; }
    .btn-primary-custom { background:#2296c7; color:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(34,150,199,0.10); }
    .form-control { border-radius:12px; }
    .brand { color:#2664eb; font-weight:700; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container d-flex justify-content-center">
      <a class="navbar-brand mb-0 h1 text-center brand" href="/">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#2664eb"><path d="M200-280v-280h80v280h-80Zm240 0v-280h80v280h-80ZM80-120v-80h800v80H80Zm600-160v-280h80v280h-80ZM80-640v-80l400-200 400 200v80H80Z"/></svg>
        Quejas de Entidades Boyacá
      </a>
    </div>
  </nav>

  <div class="container d-flex align-items-center justify-content-center" style="min-height:70vh;">
    <div class="col-12 col-sm-10 col-md-8 col-lg-5">
      <div class="card card-custom p-4 position-relative">
        <div class="icon-bg"><i class="bi bi-person-lock"></i></div>
        <h2 class="text-center fw-bold mt-2">Iniciar sesión</h2>
        <p class="text-center text-muted mb-4">Accede para gestionar tus quejas</p>

        <form id="loginForm" class="mt-2">
          <div class="mb-3">
            <label for="username" class="form-label fw-semibold">Usuario</label>
            <input type="text" class="form-control" id="username" name="username" placeholder="Tu usuario" required minlength="3" />
          </div>
          <div class="mb-4">
            <label for="password" class="form-label fw-semibold">Contraseña</label>
            <input type="password" class="form-control" id="password" name="password" placeholder="Tu contraseña" required minlength="4" />
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary-custom fw-bold py-2">Entrar</button>
          </div>
        </form>

        <div class="text-center mt-3">
          <a href="/" class="text-decoration-none">Volver al inicio</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Manejar el envío del formulario de login
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Guardar username en localStorage
          localStorage.setItem('username', username);
          
          Swal.fire({
            icon: 'success',
            title: 'Inicio de sesión exitoso',
            text: data.message,
            confirmButtonColor: '#2296c7',
            timer: 1500,
            showConfirmButton: false
          }).then(() => {
            // Verificar si hay una URL de redirección guardada
            const redirectUrl = localStorage.getItem('redirectAfterLogin');
            if (redirectUrl) {
              localStorage.removeItem('redirectAfterLogin');
              window.location.href = redirectUrl;
            } else {
              // Si no hay URL guardada, ir a la página principal
              window.location.href = '/';
            }
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.message || 'Error al iniciar sesión',
            confirmButtonColor: '#2296c7'
          });
        }
      } catch (error) {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error al conectar con el servidor',
          confirmButtonColor: '#2296c7'
        });
      }
    });
  </script>

  <% if (typeof alert !== 'undefined') { %>
  <script>
    Swal.fire({
      icon: '<%= alert.type %>',
      title: '<%= alert.title %>',
      text: '<%= alert.message %>',
      confirmButtonColor: '#2296c7'
    });
  </script>
  <% } %>
</body>
</html>
